<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ì˜ì‚¬ í‚¤ìš°ê¸° : í—˜ë‚œí•œ ì˜ì‚¬ì˜ ê¸¸ (Remastered)</title>
    
    <style>
        /* --- [ê¸°ë³¸ ìŠ¤íƒ€ì¼] --- */
        /* [ìˆ˜ì •] body ìŠ¤íƒ€ì¼: ì˜ë¦¼ ë°©ì§€ ë° ì•ˆì „ ì˜ì—­ í™•ë³´ */
        body {
            margin: 0; padding: 0; background-color: #f0f8ff;
            font-family: 'Apple SD Gothic Neo', sans-serif;
            display: flex; flex-direction: column; 
            
            /* vh ëŒ€ì‹  dvh ì‚¬ìš© (ëª¨ë°”ì¼ ë§ì¶¤ ë†’ì´) */
            height: 100dvh; 
            
            overflow: hidden; user-select: none; -webkit-tap-highlight-color: transparent;
            transition: background-color 0.5s;

            /* --- [ì¤‘ìš”] ë…¸ì¹˜ ë° í•˜ë‹¨ ë°” ì•ˆì „ ì˜ì—­ í™•ë³´ --- */
            padding-top: env(safe-area-inset-top);
            padding-bottom: env(safe-area-inset-bottom);
            padding-left: env(safe-area-inset-left);
            padding-right: env(safe-area-inset-right);
            box-sizing: border-box; /* íŒ¨ë”©ì´ ë†’ì´ì— í¬í•¨ë˜ë„ë¡ ì„¤ì • */
        }
        /* í”¼ë²„ ëª¨ë“œì¼ ë•Œ ë°°ê²½ì´ ì‚´ì§ ë¶‰ê²Œ ë³€í•¨ */
        body.fever-mode { background-color: #fff0f0; }

        /* ì‹œì‘ í™”ë©´ */
        #start-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: #e3f2fd; z-index: 9999;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
        }
        .intro-box {
            background: white; padding: 30px; border-radius: 20px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1); text-align: center; width: 85%; max-width: 350px;
        }
        .intro-title { font-size: 28px; font-weight: 900; color: #0056b3; margin-bottom: 20px; }
        .gender-btn {
            width: 45%; padding: 15px; border: 2px solid #ddd; border-radius: 10px;
            background: #fff; font-size: 16px; font-weight: bold; cursor: pointer; margin: 5px;
        }
        .gender-btn.selected { border-color: #4facfe; background-color: #e6f7ff; color: #0056b3; }
        .login-input {
            width: 100%; padding: 15px; margin-bottom: 10px; border: 2px solid #ddd;
            border-radius: 10px; font-size: 16px; box-sizing: border-box; text-align: center;
        }
        #start-game-btn {
            width: 100%; padding: 15px; margin-top: 10px; border: none; border-radius: 10px;
            background: #4facfe; color: white; font-size: 18px; font-weight: bold; cursor: pointer;
        }

        /* ìƒë‹¨ë°” */
        .top-bar {
            flex: 0 0 auto; padding: 10px 15px; background-color: rgba(255,255,255,0.9);
            text-align: center; box-shadow: 0 2px 10px rgba(0,0,0,0.05); z-index: 10;
            display: flex; flex-direction: column; gap: 5px;
        }
        #player-info { font-size: 14px; font-weight: bold; color: #333; }
        #level-display { font-size: 16px; font-weight: bold; color: #555; }
        
        /* ì§€ì‹ í¬ì¸íŠ¸ í‘œì‹œ (ì¤‘ìš”) */
        .knowledge-box {
            background-color: #e3f2fd; padding: 8px 15px; border-radius: 20px;
            font-size: 18px; font-weight: 900; color: #0056b3; display: inline-block; margin: 0 auto;
            border: 2px solid #bbdefb;
        }
        .knowledge-highlight { color: #ff9800; font-size: 20px; } /* í¬ì¸íŠ¸ ê°•ì¡°ìƒ‰ */

        /* ìºë¦­í„° ì˜ì—­ (í„°ì¹˜í•´ì„œ ì§€ì‹ ìŒ“ëŠ” ê³³) */
        .character-area {
            flex: 1; display: flex; flex-direction: column; justify-content: center; align-items: center;
            position: relative; background-color: transparent; overflow: hidden;
            cursor: pointer; /* í´ë¦­ ê°€ëŠ¥í•˜ë‹¤ëŠ” í‘œì‹œ */
        }
        /* ìºë¦­í„° ì´ë¯¸ì§€ í„°ì¹˜ íš¨ê³¼ */
        #char-img {
            max-width: 80%; max-height: 55%; object-fit: contain;
            transition: transform 0.1s; filter: drop-shadow(0 10px 10px rgba(0,0,0,0.1)); z-index: 1;
        }
        #char-img:active { transform: scale(0.9) !important; } /* ëˆŒë €ì„ ë•Œ ì‘ì•„ì§ */

        /* ì•„ì´í…œ(í•˜íŠ¸) ì‚¬ìš© ì˜ì—­ */
        .item-container {
            width: 100%; display: flex; justify-content: center; align-items: center;
            margin-top: 10px; z-index: 5;
        }
        .heart-btn {
            background-color: #ff4081; color: white; border: none;
            padding: 8px 20px; border-radius: 25px; font-size: 15px; font-weight: bold;
            box-shadow: 0 4px 0 #c60055; cursor: pointer; display: flex; align-items: center; gap: 5px;
            transition: transform 0.1s;
        }
        .heart-btn:active { box-shadow: none; transform: translateY(4px); }
        .heart-btn:disabled { background-color: #ccc; box-shadow: none; cursor: not-allowed; }

        /* í”¼ë²„ ê²Œì´ì§€ë°” (ì‹œê°„ì œí•œ í‘œì‹œìš©) */
        .fever-timer-box {
            width: 60%; height: 10px; background-color: #ddd; border-radius: 5px;
            margin-top: 5px; overflow: hidden; display: none; /* í‰ì†Œì—” ìˆ¨ê¹€ */
        }
        #fever-timer-bar { width: 100%; height: 100%; background: linear-gradient(90deg, #ff9a9e, #ff5252); }

        /* í•˜ë‹¨ íŒ¨ë„ (ê³¼ëª© ê³µë¶€) */
        /* [ìˆ˜ì •] í•˜ë‹¨ íŒ¨ë„: ë‚´ìš©ì´ ë„˜ì¹˜ë©´ ìŠ¤í¬ë¡¤ ê°€ëŠ¥í•˜ê²Œ ë³€ê²½ */
        .bottom-panel {
            flex: 0 1 auto; /* ë†’ì´ ìœ ë™ì  ì¡°ì ˆ */
            background-color: white;
            border-top-left-radius: 25px; border-top-right-radius: 25px;
            padding: 20px 15px 30px 15px; box-shadow: 0 -5px 20px rgba(0,0,0,0.1);
            display: flex; flex-direction: column; align-items: center; 
            min-height: 35%;
            
            /* --- [ì¶”ê°€] ë‚´ìš©ì´ ë§ìœ¼ë©´ ìŠ¤í¬ë¡¤ ìƒê¸°ê²Œ í•¨ --- */
            overflow-y: auto; 
            max-height: 60vh; /* í™”ë©´ì˜ 60% ì´ìƒ ì°¨ì§€í•˜ì§€ ì•Šê²Œ ì œí•œ */
        }
        #entrance-exam-area, #study-area, #exam-modal-area { width: 100%; max-width: 500px; display: flex; flex-direction: column; align-items: center; }

        /* ì‹œí—˜ì¥ ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
        #exam-modal-area { background-color: #fff3cd; padding: 20px; border-radius: 15px; border: 2px solid #ffecb5; text-align: center;}
        .exam-title { font-size: 20px; font-weight: bold; color: #555; margin-bottom: 10px; }
        .math-problem { font-size: 40px; font-weight: bold; color: #d35400; margin: 20px 0; letter-spacing: 5px; }

        /* ê³µë¶€ ë²„íŠ¼ë“¤ */
        .study-btn {
            position: relative; height: 45px; /* ë†’ì´ ëŒ€í­ ì¶•ì†Œ */
            border-radius: 8px; border: none; font-weight: bold; color: white;
            cursor: pointer; box-shadow: 0 2px 4px rgba(0,0,0,0.15);
            display: flex; flex-direction: row; /* ê°€ë¡œ ë°°ì¹˜ */
            justify-content: space-between; /* ì–‘ ë ì •ë ¬ */
            align-items: center; padding: 0 15px; /* ì¢Œìš° ì—¬ë°± */
            font-size: 14px; margin: 0;
        }
        .study-btn:active { transform: scale(0.98); }
        .study-btn.disabled { background-color: #e0e0e0 !important; color: #999; box-shadow: none; }
        
        .count-badge { font-size: 11px; margin-top: 3px; opacity: 0.9; }
        .cost-badge { 
            font-size: 10px; background: rgba(0,0,0,0.2); 
            padding: 2px 4px; border-radius: 4px; margin-bottom: 2px; 
        }

        
        .list-layout { display: flex; flex-direction: column; gap: 6px; width: 100%; }
        .list-layout .study-btn { flex-direction: row; justify-content: space-between; padding: 15px 20px; font-size: 16px; }
        .grid-3x3 { display: grid; grid-template-columns: repeat(3, 1fr); gap: 6px; width: 100%; }
        .grid-3x3 .study-btn { height: 45px; font-size: 13px; padding: 0 8px; } /* í°íŠ¸ ì¡°ê¸ˆ ì‘ê²Œ */
        .grid-3x4 { display: grid; grid-template-columns: repeat(3, 1fr); gap: 5px; width: 100%; }
        .grid-3x4 .study-btn { height: 45px; font-size: 13px; padding: 0 8px; }
        .select-grid { display: grid !important; grid-template-columns: repeat(2, 1fr); gap: 10px; width: 100%; }
        
        .choice-btn { background-color: #fff; border: 2px solid #0056b3; color: #0056b3; padding: 15px; font-size: 15px; border-radius: 10px; font-weight: bold; cursor: pointer; }
        .choice-btn:active { background-color: #e6f0ff; transform: scale(0.98); }

        input[type="text"], input[type="number"], input[type="password"] { 
            width: 100%; padding: 12px; font-size: 16px; margin-top: 10px; 
            box-sizing: border-box; text-align: center; border: 2px solid #ddd; border-radius: 8px; 
        }
        input[type="number"] { font-size: 24px; font-weight: bold; }

        #promote-btn, #submit-exam-btn { margin-top: 15px; padding: 15px 0; width: 100%; background-color: #e0e0e0; color: #888; border: none; border-radius: 15px; font-size: 18px; font-weight: bold; cursor: not-allowed; }
        #promote-btn.active { background-color: #ff6b6b; color: white; cursor: pointer; animation: pulse 1.5s infinite; }
        #submit-exam-btn { background-color: #27ae60; animation: none; color: white; cursor: pointer; }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.02); } 100% { transform: scale(1); } }
        
        #cheat-btn { position: fixed; top: 10px; right: 10px; z-index: 999; background: #ff4757; color: white; border: none; padding: 5px 10px; border-radius: 5px; font-weight: bold; cursor: pointer; }
        #back-btn { position: fixed; top: 10px; right: 90px; z-index: 999; background: #57606f; color: white; border: none; padding: 5px 10px; border-radius: 5px; font-weight: bold; cursor: pointer; }
        
        #loading-msg { color: #888; margin-top: 10px; font-size: 14px; display: none; }
        .hidden { display: none !important; }

        /* ìƒ‰ìƒ ìœ í‹¸ë¦¬í‹° */
        .bg-blue { background-color: #4facfe; } .bg-pink { background-color: #ff9a9e; }
        .bg-purple { background-color: #a18cd1; } .bg-green { background-color: #43e97b; }
        .bg-orange { background-color: #fbc2eb; } .bg-yellow { background-color: #fa709a; }
        .bg-gold { background-color: #f6d365; color: #555; }
        .bg-med { background-color: #00c6fb; } .bg-res { background-color: #4834d4; }
        .bg-fel { background-color: #6c5ce7; } .bg-doc { background-color: #00b894; }
        
        /* ì•Œë¦¼ ë©”ì‹œì§€ (í„°ì¹˜ ì‹œ ëœ¨ëŠ” +1 íš¨ê³¼ ë“±) */
        .floating-text {
            position: absolute; font-weight: bold; font-size: 20px; color: #0056b3;
            animation: floatUp 0.8s ease-out forwards; pointer-events: none; z-index: 100;
        }
        @keyframes floatUp { 0% { opacity: 1; transform: translateY(0); } 100% { opacity: 0; transform: translateY(-50px); } }

        /* ìŠ¤íƒ¯ ë²„íŠ¼ (í•œ ì¤„ ìŠ¤íƒ€ì¼) */
        .stat-upgrade-box {
            display: flex; 
            flex-direction: row; 
            justify-content: space-between; 
            gap: 5px; 
            width: 100%; 
            margin-bottom: 15px; /* ì•„ë˜ìª½ ì—¬ë°± ì¡°ê¸ˆ ë” ì¤Œ */
            padding: 10px;       /* ì•ˆìª½ ì—¬ë°± */
            border: 2px dashed #90caf9; /* íŒŒë€ ì ì„  í…Œë‘ë¦¬ */
            border-radius: 12px; /* ë‘¥ê·¼ ëª¨ì„œë¦¬ */
            background-color: rgba(255, 255, 255, 0.6); /* ì‚´ì§ í° ë°°ê²½ */
            box-sizing: border-box; /* í…Œë‘ë¦¬ í¬í•¨ í¬ê¸° ê³„ì‚° */
        }
        .stat-btn {
            flex: 1; height: 40px; /* ë†’ì´ ê³ ì • */
            padding: 0 10px; border: none; border-radius: 8px;
            font-size: 13px; font-weight: bold; color: #fff; cursor: pointer;
            display: flex; flex-direction: row; /* ê°€ë¡œ ë°°ì¹˜ */
            justify-content: center; align-items: center; /* ì¤‘ì•™ ì •ë ¬ */
            gap: 5px; /* ì•„ì´ì½˜ê³¼ í…ìŠ¤íŠ¸ ì‚¬ì´ ê°„ê²© */
            box-shadow: 0 2px 0 rgba(0,0,0,0.2); 
        }
        .stat-btn:active { transform: translateY(2px); box-shadow: none; }
        .stat-btn:disabled { background-color: #ccc !important; box-shadow: none; }
        
        .stat-reading { background-color: #3498db; } /* íŒŒë‘ */
        .stat-fitness { background-color: #e67e22; } /* ì£¼í™© */
        .stat-mental { background-color: #2ecc71; }  /* ì´ˆë¡ */
        
        .stat-cost { font-size: 10px; opacity: 0.8; margin-top: 2px; }

        /* [ì¶”ê°€] ì°¨ê° í…ìŠ¤íŠ¸ ìŠ¤íƒ€ì¼ (ë¹¨ê°„ìƒ‰ ê¸€ì”¨) */
        .minus-text {
            position: absolute;       /* ë‘¥ë‘¥ ë– ë‹¤ë‹ˆê²Œ ì„¤ì • */
            color: #ff4444;           /* ë¹¨ê°„ìƒ‰ (ê²½ê³ /ì°¨ê° ëŠë‚Œ) */
            font-weight: bold;        /* ê¸€ì”¨ êµµê²Œ */
            font-size: 20px;          /* ê¸€ì”¨ í¬ê¸° */
            pointer-events: none;     /* ë§ˆìš°ìŠ¤ í´ë¦­ ë°©í•´ ê¸ˆì§€ */
            z-index: 1000;            /* ë‹¤ë¥¸ ìš”ì†Œë“¤ë³´ë‹¤ ìœ„ì— í‘œì‹œ */
            animation: floatUpFade 1s ease-out forwards; /* 1ì´ˆ ë™ì•ˆ ìœ„ë¡œ ëœ¨ë©° ì‚¬ë¼ì§ */
        }
        
        /* [ì¶”ê°€] í…ìŠ¤íŠ¸ê°€ ìœ„ë¡œ ì˜¬ë¼ê°€ë©´ì„œ íˆ¬ëª…í•´ì§€ëŠ” ì• ë‹ˆë©”ì´ì…˜ */
        @keyframes floatUpFade {
            0% {
                opacity: 1;           /* ì„ ëª…í•˜ê²Œ ì‹œì‘ */
                transform: translateY(0); /* ì›ë˜ ìœ„ì¹˜ */
            }
            100% {
                opacity: 0;           /* íˆ¬ëª…í•´ì§ */
                transform: translateY(-30px); /* ìœ„ë¡œ 30px ì´ë™ */
            }
        }
    </style>
</head>
<body>

    <div id="start-screen">
        <div class="intro-box">
            <div class="intro-title">ğŸ‘¨â€âš•ï¸ ì˜ì‚¬ í‚¤ìš°ê¸°<br><span style="font-size:16px; color:#555;">(Remastered)</span></div>
            <input type="text" id="intro-name" class="login-input" placeholder="ì´ë¦„ (ì•„ì´ë””)" >
            <input type="password" id="intro-pass" class="login-input" placeholder="ë¹„ë°€ë²ˆí˜¸ 4ìë¦¬" maxlength="4">
            <div style="display:flex; justify-content:center; margin-top:15px;">
                <button class="gender-btn selected" onclick="window.selectGender('m', this)">ë‚¨ì</button>
                <button class="gender-btn" onclick="window.selectGender('f', this)">ì—¬ì</button>
            </div>
            <button id="start-game-btn" onclick="window.loginOrSignup()">ì‹œì‘í•˜ê¸° / ì´ì–´í•˜ê¸°</button>
            <div id="loading-msg">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
        </div>
    </div>

    <button id="cheat-btn" onclick="window.cheatPass()">âš¡ íŒ¨ìŠ¤</button>
    <button id="back-btn" onclick="window.cheatBack()">ğŸ”™ ë’¤ë¡œ</button>

    <div class="top-bar">
        <div id="player-info">í”Œë ˆì´ì–´ ì •ë³´ ë¡œë”©ì¤‘...</div>
        <div id="level-display">ì…í•™ ì‹œí—˜ ì¤‘...</div>
        
        <div class="knowledge-box">
            ğŸ“š ì§€ì‹: <span id="knowledge-cnt" class="knowledge-highlight">0</span>
        </div>
    </div>

    <div class="character-area" onclick="window.clickCharacter(event)">
        <img id="char-img" src="" alt="ìºë¦­í„°">
        
        <div class="item-container">
            <button id="heart-btn" class="heart-btn" onclick="window.useHeart(event)">
                â¤ï¸ Fever (<span id="heart-cnt">5</span>ê°œ)
            </button>
        </div>
        <div id="fever-timer-container" class="fever-timer-box">
            <div id="fever-timer-bar"></div>
        </div>
        <p style="font-size:12px; color:#666; margin-top:5px;">ğŸ‘† ìºë¦­í„°ë¥¼ í„°ì¹˜í•´ ì§€ì‹ì„ ëª¨ìœ¼ì„¸ìš”!</p>
    </div>

    <div class="bottom-panel">
        
        <div id="entrance-exam-area">
            <h3>[ 1í•™ë…„ ë°›ì•„ì“°ê¸° ]</h3>
            <p style="margin:5px 0;">"í›Œë¥­í•œ ì˜ì‚¬ê°€ ë˜ì"</p>
            <input type="text" id="typing-input" placeholder="ì—¬ê¸°ì— ì…ë ¥" oninput="window.checkTyping()">
            <p id="exam-msg" style="font-size:12px; color:green; height: 15px; margin:5px 0;"></p>
        </div>

        <div id="exam-modal-area" class="hidden">
            <h3 id="exam-title-display" class="exam-title">[ ì‹œí—˜ ]</h3>
            <p id="exam-desc-display">ë‹¤ìŒ ë¬¸ì œë¥¼ ë§íˆì„¸ìš”!</p>
            <div id="math-problem-display" class="math-problem">3 + 5 = ?</div>
            <input type="number" id="math-input" placeholder="ì •ë‹µ ì…ë ¥">
            <button id="submit-exam-btn" onclick="window.checkExamAnswer()">ë‹µì•ˆ ì œì¶œ</button>
        </div>

        <div id="study-area" class="hidden">
            
            <div id="stat-upgrade-group" class="stat-upgrade-box hidden">
                <button id="btn-stat-read" class="stat-btn stat-reading" onclick="window.upgradeStat('reading')">
                    ğŸ“š ë…ì„œ Lv.<span id="lv-read">0</span>
                </button>
                <button id="btn-stat-fit" class="stat-btn stat-fitness" onclick="window.upgradeStat('fitness')">
                    ğŸ’ª ì²´ë ¥ Lv.<span id="lv-fit">0</span>
                </button>
                <button id="btn-stat-ment" class="stat-btn stat-mental" onclick="window.upgradeStat('mentality')">
                    ğŸ§  ì •ì‹  Lv.<span id="lv-ment">0</span>
                </button>
            </div>

            <div id="elem-group" class="list-layout hidden">
                <button id="btn-reading" class="study-btn bg-blue" onclick="window.clickSubject('reading')">
                    <span>ğŸ“– ë…ì„œ</span> <span id="cnt-reading">0/5</span>
                </button>
                <button id="btn-english" class="study-btn bg-pink hidden" onclick="window.clickSubject('english')">
                    <span>ğŸ”¤ ì˜ì–´</span> <span id="cnt-english">0/5</span>
                </button>
                <button id="btn-math" class="study-btn bg-purple hidden" onclick="window.clickSubject('math')">
                    <span>â• ìˆ˜í•™</span> <span id="cnt-math">0/5</span>
                </button>
            </div>
            
            <div id="secondary-group" class="grid-3x3 hidden">
                <button id="btn-kor" class="study-btn bg-blue" onclick="window.clickSubject('kor')">
                    <span>ğŸ“š êµ­ì–´</span><span id="cnt-kor">0/5</span>
                </button>
                <button id="btn-eng_m" class="study-btn bg-pink" onclick="window.clickSubject('eng_m')">
                    <span>ğŸ”¤ ì˜ì–´</span><span id="cnt-eng_m">0/5</span>
                </button>
                <button id="btn-math_m" class="study-btn bg-purple" onclick="window.clickSubject('math_m')">
                    <span>âœ–ï¸ ìˆ˜í•™</span><span id="cnt-math_m">0/5</span>
                </button>

                <button id="btn-sci" class="study-btn bg-green" onclick="window.clickSubject('sci')">
                    <span>ğŸ§¬ ê³¼í•™</span><span id="cnt-sci">0/5</span>
                </button>
                <button id="btn-soc" class="study-btn bg-orange" onclick="window.clickSubject('soc')">
                    <span>ğŸŒ ì‚¬íšŒ</span><span id="cnt-soc">0/5</span>
                </button>
                <button id="btn-info" class="study-btn bg-blue" onclick="window.clickSubject('info')"> <span>ğŸ’» ì •ë³´</span><span id="cnt-info">0/5</span>
                </button>

                <button id="btn-vol" class="study-btn bg-orange" onclick="window.clickSubject('vol', 3)">
                    <span>ğŸ¤ ë´‰ì‚¬</span><span id="cnt-vol">0/3</span>
                </button>
                <button id="btn-lead" class="study-btn bg-gold" onclick="window.clickSubject('lead', 3)">
                    <span>ğŸ‘‘ ì„ì›</span><span id="cnt-lead">0/3</span>
                </button>
                <button id="btn-contest" class="study-btn bg-yellow" onclick="window.clickSubject('contest', 3)"> <span>ğŸ† ê²½ì‹œëŒ€íšŒ</span><span id="cnt-contest">0/3</span>
                </button>
            </div>

            <div id="med-group" class="grid-3x4 hidden">
                <button id="btn-med1" class="study-btn bg-med" onclick="window.clickSubject('med1')"><span class="lbl">1</span><span id="cnt-med1">0/5</span></button>
                <button id="btn-med2" class="study-btn bg-med" onclick="window.clickSubject('med2')"><span class="lbl">2</span><span id="cnt-med2">0/5</span></button>
                <button id="btn-med3" class="study-btn bg-med" onclick="window.clickSubject('med3')"><span class="lbl">3</span><span id="cnt-med3">0/5</span></button>
                <button id="btn-med4" class="study-btn bg-med" onclick="window.clickSubject('med4')"><span class="lbl">4</span><span id="cnt-med4">0/5</span></button>
                <button id="btn-med5" class="study-btn bg-med" onclick="window.clickSubject('med5')"><span class="lbl">5</span><span id="cnt-med5">0/5</span></button>
                <button id="btn-med6" class="study-btn bg-med" onclick="window.clickSubject('med6')"><span class="lbl">6</span><span id="cnt-med6">0/5</span></button>
                <button id="btn-med7" class="study-btn bg-med" onclick="window.clickSubject('med7')"><span class="lbl">7</span><span id="cnt-med7">0/5</span></button>
                <button id="btn-med8" class="study-btn bg-med" onclick="window.clickSubject('med8')"><span class="lbl">8</span><span id="cnt-med8">0/5</span></button>
                <button id="btn-med9" class="study-btn bg-med" onclick="window.clickSubject('med9')"><span class="lbl">9</span><span id="cnt-med9">0/5</span></button>
                <button id="btn-med10" class="study-btn bg-med" onclick="window.clickSubject('med10')"><span class="lbl">10</span><span id="cnt-med10">0/5</span></button>
                <button id="btn-med11" class="study-btn bg-med" onclick="window.clickSubject('med11')"><span class="lbl">11</span><span id="cnt-med11">0/5</span></button>
                <button id="btn-med12" class="study-btn bg-med" onclick="window.clickSubject('med12')"><span class="lbl">12</span><span id="cnt-med12">0/5</span></button>
            </div>

            <div id="major-select-group" class="select-grid hidden">
                <button class="choice-btn" onclick="window.selectMajor('ë‚´ê³¼')">ë‚´ê³¼</button>
                <button class="choice-btn" onclick="window.selectMajor('ì™¸ê³¼')">ì™¸ê³¼</button>
                <button class="choice-btn" onclick="window.selectMajor('ì‚°ë¶€ì¸ê³¼')">ì‚°ë¶€ì¸ê³¼</button>
                <button class="choice-btn" onclick="window.selectMajor('ì†Œì•„ì²­ì†Œë…„ê³¼')">ì†Œì•„ì²­ì†Œë…„ê³¼</button>
                <button class="choice-btn" onclick="window.selectMajor('ì •ì‹ ê³¼')">ì •ì‹ ê³¼</button>
                <button class="choice-btn" onclick="window.selectMajor('í”¼ë¶€ê³¼')">í”¼ë¶€ê³¼</button>
                <button class="choice-btn" onclick="window.selectMajor('ì•ˆê³¼')">ì•ˆê³¼</button>
                <button class="choice-btn" onclick="window.selectMajor('ì •í˜•ì™¸ê³¼')">ì •í˜•ì™¸ê³¼</button>
                <button class="choice-btn" onclick="window.selectMajor('ì¬í™œì˜í•™ê³¼')">ì¬í™œì˜í•™ê³¼</button>
                <button class="choice-btn" onclick="window.selectMajor('ì˜ìƒì˜í•™ê³¼')">ì˜ìƒì˜í•™ê³¼</button>
            </div>
            <div id="career-select-group" class="select-grid hidden">
                <button class="choice-btn" onclick="window.selectCareer('fellow')">ğŸ“ í ë¡œìš° (ì „ì„ì˜)</button>
                <button class="choice-btn" onclick="window.selectCareer('bongjik')">ğŸ¥ ë´‰ì§ì˜ (í˜ì´ë‹¥í„°)</button>
            </div>
        </div>

        <button id="promote-btn" onclick="window.tryPromote()">ì§„ê¸‰ í•˜ê¸°</button>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";


        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        window.addEventListener('DOMContentLoaded', () => {
            const savedName = localStorage.getItem('dr_maker_name');
            const savedPass = localStorage.getItem('dr_maker_pass');
            if(savedName) document.getElementById('intro-name').value = savedName;
            if(savedPass) document.getElementById('intro-pass').value = savedPass;
        });

        // --- ì „ì—­ ë³€ìˆ˜ ---
        let playerName = ""; let playerGender = "m"; let playerAge = 7; let playerPass = "";
        let totalScore = 0; // ëˆ„ì  ì ìˆ˜ (ê²½í—˜ì¹˜)
        let currentKnowledge = 0; // í˜„ì¬ ë³´ìœ  ì§€ì‹ (ëˆ ê°œë…) - NEW
        let currentHearts = 5; // ë³´ìœ  í•˜íŠ¸ (ì•„ì´í…œ) - NEW
        
        let currentLevelIdx = 0; let myMajor = ""; 
        let retryCount = 0; 
        let mathAnswer = 0; 
        let currentExamType = ""; 
        let kmlePassed = false; 
        let entranceExamPassed = false;

        let isFeverMode = false; // í”¼ë²„ ìƒíƒœ
        const KNOWLEDGE_COST = 3; // ê³¼ëª© ê³µë¶€í•  ë•Œ ë“œëŠ” ì§€ì‹ ë¹„ìš©

        let subjectCounts = {
            reading: 0, english: 0, math: 0, 
            kor: 0, eng_m: 0, math_m: 0, sci: 0, soc: 0, info: 0, vol: 0, lead: 0, contest: 0, // ì¤‘ê³ ë“± ê°œí¸
            med1:0, med2:0, med3:0, med4:0, med5:0, med6:0, med7:0, med8:0, med9:0, med10:0, med11:0, med12:0
        };

        let statLevels = { reading: 0, fitness: 0, mentality: 0 };    
        

        const levels = [
            { name: "ì´ˆë“± 1í•™ë…„", type: 'elem_low', req: 5 }, { name: "ì´ˆë“± 2í•™ë…„", type: 'elem_low', req: 5 }, { name: "ì´ˆë“± 3í•™ë…„", type: 'elem_low', req: 5 },
            { name: "ì´ˆë“± 4í•™ë…„", type: 'elem_high', req: 5 }, { name: "ì´ˆë“± 5í•™ë…„", type: 'elem_high', req: 5 }, { name: "ì´ˆë“± 6í•™ë…„", type: 'elem_high', req: 5 },
            { name: "ì¤‘í•™êµ 1í•™ë…„", type: 'middle', req: 5 }, { name: "ì¤‘í•™êµ 2í•™ë…„", type: 'middle', req: 5 }, { name: "ì¤‘í•™êµ 3í•™ë…„", type: 'middle', req: 5 },
            { name: "ê³ ë“±í•™êµ 1í•™ë…„", type: 'middle', req: 5 }, { name: "ê³ ë“±í•™êµ 2í•™ë…„", type: 'middle', req: 5 }, 
            { name: "ê³ ë“±í•™êµ 3í•™ë…„", type: 'middle', req: 5, isCheckpoint: true },
            { name: "ì˜ì˜ˆê³¼ 1í•™ë…„", type: 'med', req: 5 }, { name: "ì˜ì˜ˆê³¼ 2í•™ë…„", type: 'med', req: 5 },
            { name: "ì˜í•™ê³¼ 1í•™ë…„", type: 'med', req: 5 }, { name: "ì˜í•™ê³¼ 2í•™ë…„", type: 'med', req: 5 },
            { name: "ì˜í•™ê³¼ 3í•™ë…„ (PKì‹¤ìŠµ)", type: 'med', req: 5 }, 
            { name: "ì˜í•™ê³¼ 4í•™ë…„ (êµ­ì‹œì¤€ë¹„)", type: 'med', req: 5, isCheckpoint: true },
            { name: "ì¸í„´ (ìˆ˜ë ¨ì˜)", type: 'intern', req: 5 },
            { name: "ì „ê³µì˜ ì§€ì›", type: 'select_major', req: 0, isCheckpoint: true },
            { name: "ë ˆì§€ë˜íŠ¸ 1ë…„ì°¨", type: 'resident', req: 5 }, { name: "ë ˆì§€ë˜íŠ¸ 2ë…„ì°¨", type: 'resident', req: 5 },
            { name: "ë ˆì§€ë˜íŠ¸ 3ë…„ì°¨", type: 'resident', req: 5 }, 
            { name: "ë ˆì§€ë˜íŠ¸ 4ë…„ì°¨ (ì¹˜í”„)", type: 'resident', req: 5, isCheckpoint: true },
            { name: "êµ°ì˜ê´€ 1ë…„ì°¨", type: 'military', req: 5 }, { name: "êµ°ì˜ê´€ 2ë…„ì°¨", type: 'military', req: 5 }, { name: "êµ°ì˜ê´€ 3ë…„ì°¨", type: 'military', req: 5 },
            { name: "ì§„ë¡œ ì„ íƒ", type: 'select_career', req: 0, isCheckpoint: true },
            { name: "í ë¡œìš° 1ë…„ì°¨", type: 'fellow', req: 5 }, { name: "í ë¡œìš° 2ë…„ì°¨", type: 'fellow', req: 5 },
            { name: "ëŒ€í•™ë³‘ì› êµìˆ˜", type: 'professor', req: 9999, isCheckpoint: true },
            { name: "ë´‰ì§ì˜ 1ë…„ì°¨", type: 'bongjik', req: 5 }, { name: "ë´‰ì§ì˜ 2ë…„ì°¨", type: 'bongjik', req: 5 },
            { name: "ê°œì›ë³‘ì› ëŒ€í‘œì›ì¥", type: 'director', req: 9999, isCheckpoint: true }
        ];

        let cumulativeScoreMap = [];
        function initScoreThresholds() {
            let acc = 0; levels.forEach((lvl) => { lvl.entryScore = acc; let p=0;
                if(lvl.type === 'elem_low') p=5; else if(lvl.type === 'elem_high') p=15; else if(lvl.type === 'middle') p=45;
                else if(['med','intern','resident','exam','fellow','bongjik','military'].includes(lvl.type)) p=60;
                acc += p; });
        }
        initScoreThresholds();

        async function saveGame() {
            if (!playerName || !playerPass) return;
            try { await setDoc(doc(db, "users", playerName), { 
                password: playerPass, gender: playerGender, age: playerAge, score: totalScore, 
                levelIdx: currentLevelIdx, major: myMajor, counts: subjectCounts, retry: retryCount, kmle: kmlePassed, 
                entranceExamPassed: entranceExamPassed,
                knowledge: currentKnowledge, // ì €ì¥ ì¶”ê°€
                hearts: currentHearts, // ì €ì¥ ì¶”ê°€
                statLevels: statLevels // [ì¶”ê°€] ìŠ¤íƒ¯ ì €ì¥
            }); } catch (e) { console.error(e); }
        }

        window.loginOrSignup = async function() {
            const inputName = document.getElementById('intro-name').value.trim();
            const inputPass = document.getElementById('intro-pass').value.trim();
            if(!inputName || inputPass.length !== 4) { alert("ì´ë¦„ê³¼ 4ìë¦¬ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”."); return; }
            document.getElementById('loading-msg').style.display = 'block';
            try {
                const docSnap = await getDoc(doc(db, "users", inputName));
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    if (data.password === inputPass) {
                        alert(`í™˜ì˜í•©ë‹ˆë‹¤, ${inputName}ë‹˜!`);
                        localStorage.setItem('dr_maker_name', inputName);
                        localStorage.setItem('dr_maker_pass', inputPass);
                        playerName = inputName; playerPass = inputPass; playerGender = data.gender; playerAge = data.age;
                        totalScore = data.score; currentLevelIdx = data.levelIdx; myMajor = data.major || "";
                        subjectCounts = data.counts || subjectCounts;
                        statLevels = data.statLevels || { reading: 0, fitness: 0, mentality: 0 };
                        retryCount = data.retry || 0; kmlePassed = data.kmle || false;
                        entranceExamPassed = data.entranceExamPassed || false;
                        
                        // ìƒˆë¡œ ì¶”ê°€ëœ ë³€ìˆ˜ ë¶ˆëŸ¬ì˜¤ê¸° (ì—†ìœ¼ë©´ ì´ˆê¸°ê°’)
                        currentKnowledge = data.knowledge || 0;
                        currentHearts = (data.hearts !== undefined) ? data.hearts : 5;

                        document.getElementById('start-screen').style.display = 'none'; 
                        if (entranceExamPassed || currentLevelIdx > 0) {
                            document.getElementById('entrance-exam-area').classList.add('hidden');
                            document.getElementById('study-area').classList.remove('hidden');
                        }
                        updateUI();
                    } else { alert("ë¹„ë°€ë²ˆí˜¸ ë¶ˆì¼ì¹˜"); document.getElementById('loading-msg').style.display = 'none'; }
                } else {
                    if(confirm("ìƒˆë¡œ ì‹œì‘í•˜ì‹œê² ìŠµë‹ˆê¹Œ? (í•˜íŠ¸ 5ê°œ ì¦ì •)")) {
                        localStorage.setItem('dr_maker_name', inputName);
                        localStorage.setItem('dr_maker_pass', inputPass);
                        playerName = inputName; playerPass = inputPass; 
                        currentHearts = 5; // ì‹ ê·œ ìœ ì € í•˜íŠ¸ ì§€ê¸‰
                        saveGame();
                        document.getElementById('start-screen').style.display = 'none'; updateUI();
                    } else { document.getElementById('loading-msg').style.display = 'none'; }
                }
            } catch (e) { alert("DB ì—°ê²° ì˜¤ë¥˜"); document.getElementById('loading-msg').style.display = 'none'; }
        }

        window.selectGender = function(g, btn) { playerGender = g; document.querySelectorAll('.gender-btn').forEach(b => b.classList.remove('selected')); btn.classList.add('selected'); }
        
        window.cheatPass = function() {
            if (currentLevelIdx >= levels.length - 1) { alert("ìµœê³  ë ˆë²¨ì…ë‹ˆë‹¤!"); return; }
            const curLvl = levels[currentLevelIdx];
            if (curLvl.name.includes("ì˜í•™ê³¼ 4í•™ë…„") && !kmlePassed) { kmlePassed = true; }
            currentLevelIdx++; playerAge++; resetCounts(); saveGame(); updateUI();
        }
        window.cheatBack = function() {
            if (currentLevelIdx > 0) { currentLevelIdx--; playerAge--; updateUI(); }
        }
        
        window.checkTyping = function() {
            if(document.getElementById('typing-input').value === "í›Œë¥­í•œ ì˜ì‚¬ê°€ ë˜ì") {
                entranceExamPassed = true;
                document.getElementById('entrance-exam-area').classList.add('hidden');
                document.getElementById('study-area').classList.remove('hidden');
                saveGame(); updateUI();
            }
        }

        // [ìˆ˜ì •] ìºë¦­í„° í´ë¦­ í•¨ìˆ˜ (ìŠ¤íƒ¯ ë³´ë„ˆìŠ¤ ì¶”ê°€ë¨)
        window.clickCharacter = function(e) {
            e.stopPropagation(); 
            
            const curLvl = levels[currentLevelIdx];

            // 1. í•™ë…„ ê¸°ë³¸ ì ìˆ˜ (ì¸ë±ìŠ¤ + 1)
            let baseGain = currentLevelIdx + 1;

            // [ë°¸ëŸ°ìŠ¤] ë´‰ì§ì˜ ë³´ì • (í ë¡œìš°ì™€ ë™ì¼í•˜ê²Œ)
            if (curLvl.type === 'bongjik') {
                baseGain = baseGain - 3;
            }

            // 2. [ì¶”ê°€] ìŠ¤íƒ¯ ë³´ë„ˆìŠ¤ í•©ì‚° (ë…ì„œ + ì²´ë ¥ + ì •ì‹ ë ¥)
            let statBonus = statLevels.reading + statLevels.fitness + statLevels.mentality;
            let totalGain = baseGain + statBonus;

            // 3. í”¼ë²„ ëª¨ë“œ (ì´ ì ìˆ˜ì˜ 3ë°°)
            let finalGain = isFeverMode ? (totalGain * 3) : totalGain; 
            
            currentKnowledge += finalGain;

            // ì‹œê°ì  íš¨ê³¼ (+ì ìˆ˜ í‘œì‹œ)
            showFloatingText(e.clientX, e.clientY, `+${finalGain}`);
            if(navigator.vibrate) navigator.vibrate(10);
            
            saveGame(); 
            updateUI();
        }

        // [ì¶”ê°€] ìŠ¤íƒ¯ ì—…ê·¸ë ˆì´ë“œ í•¨ìˆ˜
        window.upgradeStat = function(type) {
            const cost = 10; // ì—…ê·¸ë ˆì´ë“œ ë¹„ìš©

            if (currentKnowledge >= cost) {
                currentKnowledge -= cost; // ì§€ì‹ ì†Œë¹„
                statLevels[type]++;       // í•´ë‹¹ ìŠ¤íƒ¯ ë ˆë²¨ì—…
                
                if(navigator.vibrate) navigator.vibrate(20); // ì§„ë™ íš¨ê³¼
                saveGame();
                updateUI();
            } else {
                alert("ì§€ì‹ì´ ë¶€ì¡±í•©ë‹ˆë‹¤! (í•„ìš”: 10)");
            }
        }
        // [ìƒˆë¡œìš´ ë¡œì§ 2] ê³¼ëª© ê³µë¶€ (ì§€ì‹ ì†Œë¹„)
        // [ìˆ˜ì •] ê³¼ëª© ê³µë¶€í•˜ê¸° (ìµœëŒ€ ê°œìˆ˜ ì»¤ìŠ¤í…€ ê¸°ëŠ¥ ì¶”ê°€)
        window.clickSubject = function(key, maxReq) {
            const curLvl = levels[currentLevelIdx]; 
            
            // maxReqê°€ ë“¤ì–´ì˜¤ë©´ ê·¸ê±¸ ì“°ê³ , ì—†ìœ¼ë©´ ë ˆë²¨ ê¸°ë³¸ê°’(5) ì‚¬ìš©
            const limit = (maxReq !== undefined) ? maxReq : curLvl.req;

            // ì´ë¯¸ ë§ˆìŠ¤í„°í–ˆìœ¼ë©´ ë¬´ì‹œ
            if (subjectCounts[key] >= limit) return; 

            // ì§€ì‹ì´ ì¶©ë¶„í•œì§€ í™•ì¸
            if (currentKnowledge >= KNOWLEDGE_COST) {
                currentKnowledge -= KNOWLEDGE_COST; 
                subjectCounts[key]++;               
                totalScore++;                       
                
                if(navigator.vibrate) navigator.vibrate(20);
                saveGame();
                updateUI();
            } else {
                alert("ì§€ì‹ì´ ë¶€ì¡±í•©ë‹ˆë‹¤! ìºë¦­í„°ë¥¼ ëˆŒëŸ¬ ì§€ì‹ì„ ëª¨ìœ¼ì„¸ìš”.");
            }
        }

        // [ìƒˆë¡œìš´ ë¡œì§ 3] í•˜íŠ¸ ì•„ì´í…œ ì‚¬ìš©
        window.useHeart = function(e) {
            e.stopPropagation(); // ìºë¦­í„° í´ë¦­ê³¼ ê²¹ì¹˜ì§€ ì•Šê²Œ
            
            if (isFeverMode) {
                alert("ì´ë¯¸ ì—´ê³µ ëª¨ë“œì…ë‹ˆë‹¤!");
                return;
            }

            if (currentHearts > 0) {
                currentHearts--;
                activateFeverMode();
                saveGame();
                updateUI();
            } else {
                alert("í•˜íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤ ã… ã… ");
            }
        }

       
        function activateFeverMode() {
            const ring = document.querySelector('.ring-progress');
            
            // ì´ë¯¸ ì‹¤í–‰ ì¤‘ì´ë©´ ì¤‘ë‹¨
            if (ring.classList.contains('active')) return;
        
            // ì§€ì‹ ë°•ìŠ¤ ìš”ì†Œë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤ (ì ìˆ˜ ê³„ì‚° ë° íš¨ê³¼ ìœ„ì¹˜ìš©)
            const knowledgeBox = document.getElementById('knowledge-point'); // ìˆ«ì ë¶€ë¶„
            const knowledgeContainer = document.querySelector('.knowledge-box'); // ë°•ìŠ¤ ì „ì²´(ìœ„ì¹˜ ê¸°ì¤€)
        
            let currentKnowledge = parseInt(knowledgeBox.innerText);
            
            // í¬ì¸íŠ¸ ë¶€ì¡± ì²´í¬
            if (currentKnowledge < 100) {
                alert("ì§€ì‹ì´ ë¶€ì¡±í•©ë‹ˆë‹¤! (100 í•„ìš”)");
                return;
            }
        
            // 1. í¬ì¸íŠ¸ ì°¨ê° ë¡œì§
            currentKnowledge -= 100;
            knowledgeBox.innerText = currentKnowledge;
            
            // [â˜…ì—¬ê¸° ì¶”ê°€ë¨] ì°¨ê° íš¨ê³¼ ë¿…! ë„ìš°ê¸°
            // "-100"ì´ë¼ëŠ” ê¸€ìë¥¼ ì§€ì‹ ë°•ìŠ¤(knowledgeContainer) ê·¼ì²˜ì— ë„ì›€
            showMinusEffect("-100", knowledgeContainer);
        
            // ì €ì¥í•˜ê¸° (ì´ì „ì— ì¶”ê°€í–ˆë‹¤ë©´ ìœ ì§€)
            if(typeof saveGame === 'function') saveGame(); 
        
            // 2. ì• ë‹ˆë©”ì´ì…˜ ì‹œì‘
            ring.classList.add('active');
            
            // 3. 10ì´ˆ ë’¤ ì¢…ë£Œ
            setTimeout(function() {
                ring.classList.remove('active');
                // alert("í”¼ë²„ íƒ€ì„ ì¢…ë£Œ!"); // ë„ˆë¬´ ìì£¼ ëœ¨ë©´ ê·€ì°®ìœ¼ë‹ˆ ì£¼ì„ ì²˜ë¦¬í•´ë„ ë¨
            }, 10000);
        }

        // í´ë¦­ ì‹œ +1 íš¨ê³¼ í…ìŠ¤íŠ¸ ìƒì„±
        function showFloatingText(x, y, text) {
            const el = document.createElement('div');
            el.innerText = text;
            el.className = 'floating-text';
            el.style.left = x + 'px';
            el.style.top = y + 'px';
            document.body.appendChild(el);
            setTimeout(() => el.remove(), 800);
        }

        window.selectMajor = function(majorName) {
            myMajor = majorName; 
            startExam('resident'); 
        }
        window.selectCareer = function(path) {
            currentLevelIdx = (path === 'fellow') ? 28 : 31; 
            playerAge++; 
            alert((path === 'fellow') ? "ëŒ€í•™ë³‘ì› í ë¡œìš° ê³¼ì • ì‹œì‘!" : "ë¡œì»¬ë³‘ì› ë´‰ì§ì˜ ìƒí™œ ì‹œì‘!");
            resetCounts(); saveGame(); updateUI();
        }

        function startExam(type) {
            currentExamType = type;
            document.getElementById('study-area').classList.add('hidden');
            document.getElementById('promote-btn').classList.add('hidden');
            document.getElementById('major-select-group').classList.add('hidden'); 
            document.getElementById('exam-modal-area').classList.remove('hidden');

            let title = "", desc = "ë‹¤ìŒ ë¬¸ì œë¥¼ ë§íˆì„¸ìš”!";
            if(type === 'csat') title = "ğŸ“ ëŒ€í•™ìˆ˜í•™ëŠ¥ë ¥ì‹œí—˜";
            else if(type === 'advancement') title = "ğŸ“š í•™ë…„ ì§„ê¸‰ ì‹œí—˜";
            else if(type === 'kmle') title = "ğŸ©º ì˜ì‚¬ êµ­ê°€ê³ ì‹œ (KMLE)";
            else if(type === 'intern') title = "ğŸ¥ ì¸í„´ ì„ ë°œ ì‹œí—˜";
            else if(type === 'resident') title = "ğŸ¥¼ ì „ê³µì˜ ì„ ë°œ ì‹œí—˜";
            else if(type === 'specialist') title = "ğŸ–ï¸ ì „ë¬¸ì˜ ìê²© ì‹œí—˜";

            document.getElementById('exam-title-display').innerText = title;
            document.getElementById('exam-desc-display').innerText = desc;

            const a = Math.floor(Math.random()*9)+1; const b = Math.floor(Math.random()*9)+1;
            mathAnswer = a+b; 
            document.getElementById('math-problem-display').innerText = `${a} + ${b} = ?`;
            document.getElementById('math-input').value = ""; document.getElementById('math-input').focus();
        }

        window.checkExamAnswer = function() {
            const userAns = parseInt(document.getElementById('math-input').value);
            const isCorrect = (userAns === mathAnswer);
            
            document.getElementById('exam-modal-area').classList.add('hidden');
            document.getElementById('study-area').classList.remove('hidden');

            if(isCorrect) {
                if(currentExamType === 'csat') { alert("ì¶•í•˜í•©ë‹ˆë‹¤! ì˜ê³¼ëŒ€í•™ì— í•©ê²©í•˜ì…¨ìŠµë‹ˆë‹¤!"); currentLevelIdx++; playerAge++; } 
                else if(currentExamType === 'advancement') { alert("ì§„ê¸‰ ì‹œí—˜ í•©ê²©! ë‹¤ìŒ í•™ë…„ìœ¼ë¡œ ì§„ê¸‰í•©ë‹ˆë‹¤."); currentLevelIdx++; playerAge++; }
                else if(currentExamType === 'kmle') { alert("ğŸ‰ [í•©ê²©] ì˜ì‚¬ë©´í—ˆë¥¼ ì·¨ë“í•˜ì˜€ìŠµë‹ˆë‹¤! ğŸ‰"); kmlePassed = true; }
                else if(currentExamType === 'intern') { alert("ì¸í„´ ì„ ë°œ ì‹œí—˜ í•©ê²©!"); currentLevelIdx++; playerAge++; }
                else if(currentExamType === 'resident') { alert(`[${myMajor}] ì „ê³µì˜ ì‹œí—˜ í•©ê²©!`); currentLevelIdx = 20; playerAge++; }
                else if(currentExamType === 'specialist') {
                    if (playerGender === 'm') { alert("ğŸ† ì „ë¬¸ì˜ í•©ê²©! êµ°ì˜ê´€ ì…ëŒ€!"); currentLevelIdx = 24; } 
                    else { alert("ğŸ† ì „ë¬¸ì˜ í•©ê²©!"); currentLevelIdx = 27; }
                }
                retryCount = 0; resetCounts(); saveGame(); updateUI();
            } else {
                retryCount++; playerAge++;
                alert(`ë¶ˆí•©ê²©! ë‹¤ì‹œ ê³µë¶€í•˜ì„¸ìš”.`);
                resetCounts(); saveGame(); updateUI();
            }
        }

        window.tryPromote = function() {
            if(!checkPass(levels[currentLevelIdx])) return;
            const curLvl = levels[currentLevelIdx];

            if(curLvl.name === "ê³ ë“±í•™êµ 3í•™ë…„") { startExam('csat'); return; }
            if(currentLevelIdx >= 12 && currentLevelIdx <= 16) { startExam('advancement'); return; }
            if(curLvl.name.includes("ì˜í•™ê³¼ 4í•™ë…„")) {
                if(!kmlePassed) startExam('kmle'); else startExam('intern'); return;
            }
            if(curLvl.name.includes("ë ˆì§€ë˜íŠ¸ 4ë…„ì°¨")) { startExam('specialist'); return; }

            let nextIdx = calculateSkipLevel();
            let jumpCount = nextIdx - currentLevelIdx - 1;
            if (jumpCount > 0 && currentLevelIdx < 11) alert(`${jumpCount}ë‹¨ê³„ ì›”ë°˜!`);
            currentLevelIdx = nextIdx; playerAge++; 
            resetCounts(); saveGame(); updateUI();
        }

        function updateCharacterImage(type) {
            let imgUrl = "elem_m.png";
            if(playerGender==='m'){
                if(type==='middle') imgUrl="middle_m.png"; else if(type==='med') imgUrl="med_m.png";
                else if(type==='intern'||type==='select_major') imgUrl="intern_m.png";
                else if(type==='resident'||type==='exam') imgUrl="resident_m.png";
                else if(type==='military') imgUrl="military_m.png";
                else if(type==='fellow'||type==='professor') imgUrl="fellow_m.png";
                else if(type==='bongjik'||type==='director') imgUrl="bongjik_m.png";
            } else {
                if(type.startsWith('elem')) imgUrl="emem_f.png"; else if(type==='middle') imgUrl="middle_f.png";
                else if(type==='med') imgUrl="med_f.png";
                else if(type==='intern'||type==='select_major') imgUrl="intern_f.png";
                else if(type==='resident'||type==='exam') imgUrl="https://cdn-icons-png.flaticon.com/512/3304/3304567.png";
                else if(type==='fellow'||type==='professor') imgUrl="https://cdn-icons-png.flaticon.com/512/387/387577.png";
                else if(type==='bongjik'||type==='director') imgUrl="https://cdn-icons-png.flaticon.com/512/1903/1903169.png";
                else imgUrl="https://cdn-icons-png.flaticon.com/512/2995/2995656.png";
            }
            const c=document.getElementById('char-img'); c.src=imgUrl; 
        }
        function resetCounts(){for(let k in subjectCounts)subjectCounts[k]=0;}
        function calculateSkipLevel(){if(currentLevelIdx>=11)return currentLevelIdx+1; let t=currentLevelIdx+1; for(let i=currentLevelIdx+1;i<levels.length;i++){if(totalScore>=levels[i].entryScore){t=i;if(levels[i].isCheckpoint)break;}else break;} return t;}
        // [ìˆ˜ì •] ì§„ê¸‰ ì¡°ê±´ í™•ì¸ í•¨ìˆ˜
        function checkPass(curLvl){
            const r = curLvl.req; // ê¸°ë³¸ 5
            
            if(curLvl.type === 'elem_low') return subjectCounts.reading >= r; 
            if(curLvl.type === 'elem_high') return subjectCounts.reading >= r && subjectCounts.english >= r && subjectCounts.math >= r; 
            
            // [ì¤‘ìš” ìˆ˜ì •] ì¤‘/ê³ ë“±í•™êµ í†µê³¼ ì¡°ê±´
            if(curLvl.type === 'middle') {
                // 1, 2ë²ˆì§¸ ì¤„ì€ 5ê°œ í•„ìˆ˜
                const groupA = ['kor', 'eng_m', 'math_m', 'sci', 'soc', 'info'];
                const passA = groupA.every(k => subjectCounts[k] >= r);

                // 3ë²ˆì§¸ ì¤„(ë´‰ì‚¬, ì„ì›, ê²½ì‹œëŒ€íšŒ)ì€ 3ê°œë§Œ í•˜ë©´ ë¨
                const groupB = ['vol', 'lead', 'contest'];
                const passB = groupB.every(k => subjectCounts[k] >= 3);

                return passA && passB;
            }

            if(['med','intern','resident','exam','fellow','bongjik','military'].includes(curLvl.type)){
                for(let i=1; i<=12; i++) if(subjectCounts[`med${i}`] < r) return false; return true;
            } 
            return false;
        }

        function updateUI() {
            const curLvl = levels[currentLevelIdx];
            
            let title = "ì„ ìƒë‹˜";
            if (curLvl.type.startsWith('elem') || curLvl.type === 'middle') title = "í•™ìƒ";
            else if (curLvl.type === 'med') title = "ì˜ëŒ€ìƒ";
            else if (curLvl.type === 'professor') title = "êµìˆ˜ë‹˜";
            else if (curLvl.type === 'director') title = "ì›ì¥ë‹˜";

            let genderStr = (playerGender === 'm') ? "ë‚¨" : "ì—¬";
            let statusText = curLvl.name;

            if (curLvl.name.includes("ì˜í•™ê³¼ 4í•™ë…„")) {
                if (kmlePassed) {
                    if (retryCount > 0) statusText = `ì˜ëŒ€ ì¡¸ì—… (ì¸í„´ ì¬ìˆ˜)`; else statusText = "ì˜ëŒ€ ì¡¸ì—… (ì¸í„´ì‹œí—˜ì¤€ë¹„)";
                } else { if (retryCount > 0) statusText = `êµ­ì‹œ ${retryCount}ìˆ˜ìƒ`; }
            } else if (retryCount > 0) {
                statusText = `${curLvl.name} (${retryCount+1}ìˆ˜)`;
            } else if (curLvl.type === 'resident') {
                statusText = `${myMajor} ${curLvl.name}`;
            }

            document.getElementById('player-info').innerText = `${playerName} ${title} (${playerAge}ì„¸/${genderStr})`;
            const ld = document.getElementById('level-display');
            ld.innerText = statusText;
            ld.style.color = (retryCount > 0) ? "red" : "#555";

            // ì§€ì‹ ë° í•˜íŠ¸ ì—…ë°ì´íŠ¸
            document.getElementById('knowledge-cnt').innerText = currentKnowledge;
            document.getElementById('heart-cnt').innerText = currentHearts;

            updateCharacterImage(curLvl.type);

            // [ì¶”ê°€] ìŠ¤íƒ¯ ë²„íŠ¼ ì—…ë°ì´íŠ¸
            // ì¤‘í•™êµ(ì¸ë±ìŠ¤ 6) ì´ìƒì¼ ë•Œë§Œ ë³´ì´ê²Œ ì„¤ì •
            if (currentLevelIdx >= 6) {
                document.getElementById('stat-upgrade-group').classList.remove('hidden');
                
                // ë ˆë²¨ í…ìŠ¤íŠ¸ ê°±ì‹ 
                document.getElementById('lv-read').innerText = statLevels.reading;
                document.getElementById('lv-fit').innerText = statLevels.fitness;
                document.getElementById('lv-ment').innerText = statLevels.mentality;

                // ì§€ì‹ ë¶€ì¡±í•˜ë©´ ë²„íŠ¼ ë¹„í™œì„±í™” (íšŒìƒ‰ ì²˜ë¦¬)
                const statBtns = document.querySelectorAll('.stat-btn');
                statBtns.forEach(btn => {
                    btn.disabled = (currentKnowledge < 10);
                });

            } else {
                // ì´ˆë“±í•™ìƒ ë•ŒëŠ” ìˆ¨ê¹€
                document.getElementById('stat-upgrade-group').classList.add('hidden');
            }



            ['elem-group','secondary-group','med-group','major-select-group','career-select-group'].forEach(g=>document.getElementById(g).classList.add('hidden'));
            document.getElementById('promote-btn').classList.remove('hidden');

            // ë²„íŠ¼ ìƒíƒœ (ì§€ì‹ ë¶€ì¡± ì‹œ íë¦¬ê²Œ) ì—…ë°ì´íŠ¸
            const btnList = document.querySelectorAll('.study-btn');
            btnList.forEach(btn => {
                if(currentKnowledge < KNOWLEDGE_COST) btn.classList.add('disabled');
                else btn.classList.remove('disabled');
            });

            if (curLvl.type.startsWith('elem')) {
                document.getElementById('elem-group').classList.remove('hidden');
                document.getElementById('btn-english').classList.toggle('hidden', curLvl.type === 'elem_low');
                document.getElementById('btn-math').classList.toggle('hidden', curLvl.type === 'elem_low');
                updateBtn('reading', curLvl.req); if(curLvl.type==='elem_high'){updateBtn('english', curLvl.req);updateBtn('math', curLvl.req);}

            } else if (curLvl.type === 'middle') {
            document.getElementById('secondary-group').classList.remove('hidden');
            
            // 1, 2ë²ˆì§¸ ì¤„ (ëª©í‘œ 5ê°œ)
            ['kor','eng_m','math_m','sci','soc','info'].forEach(k => updateBtn(k, curLvl.req));
            
            // 3ë²ˆì§¸ ì¤„ (ëª©í‘œ 3ê°œ) - ì—¬ê¸°ë§Œ ìˆ«ì 3ì„ ë„£ìŠµë‹ˆë‹¤
            ['vol','lead','contest'].forEach(k => updateBtn(k, 3));

            } else if (['med','intern','resident','exam','fellow','bongjik','military'].includes(curLvl.type)) {
                document.getElementById('med-group').classList.remove('hidden');
                let prefix="ê³¼ëª©", color="bg-med";
                if(curLvl.type==='intern') prefix="ì‹¤ìŠµ";
                else if(curLvl.type==='resident') { prefix="ë‹¹ì§"; color="bg-res"; }
                else if(curLvl.type==='exam') { prefix="ë¬¸ì œ"; color="bg-purple"; }
                else if(curLvl.type==='fellow') { prefix="ì—°êµ¬"; color="bg-fel"; }
                else if(curLvl.type==='bongjik') { prefix="ì§„ë£Œ"; color="bg-doc"; }
                else if(curLvl.type==='military') { prefix="í›ˆë ¨"; color="bg-green"; }
                for(let i=1; i<=12; i++){
                    const btn=document.getElementById(`btn-med${i}`); btn.querySelector('.lbl').innerText=`${prefix}${i}`;
                    btn.className=`study-btn ${color}`; updateBtn(`med${i}`, curLvl.req);
                }
            } else if (curLvl.type === 'select_major') {
                document.getElementById('major-select-group').classList.remove('hidden'); document.getElementById('promote-btn').classList.add('hidden');
            } else if (curLvl.type === 'select_career') {
                document.getElementById('career-select-group').classList.remove('hidden'); document.getElementById('promote-btn').classList.add('hidden');
            } else if (['professor','director'].includes(curLvl.type)) {
                const pb=document.getElementById('promote-btn'); pb.innerText="ğŸ† ì—”ë”© ë‹¬ì„±"; pb.disabled=true; pb.classList.remove('active'); return;
            }

            if (!['select_major','select_career','professor','director'].includes(curLvl.type)) {
                const pb = document.getElementById('promote-btn');
                if (checkPass(curLvl)) {
                    pb.classList.add('active');
                    if (curLvl.name === "ê³ ë“±í•™êµ 3í•™ë…„") pb.innerText = "ìˆ˜ëŠ¥ ì‹œí—˜ ë³´ëŸ¬ê°€ê¸°";
                    else if (currentLevelIdx >= 12 && currentLevelIdx <= 16) pb.innerText = "ì§„ê¸‰ ì‹œí—˜ ë³´ê¸°";
                    else if (curLvl.name.includes("ì˜í•™ê³¼ 4í•™ë…„")) { pb.innerText = (!kmlePassed) ? "ì˜ì‚¬ êµ­ê°€ê³ ì‹œ ë³´ê¸°" : "ì¸í„´ ì„ ë°œ ì‹œí—˜ ë³´ê¸°"; }
                    else if (curLvl.name.includes("ë ˆì§€ë˜íŠ¸ 4ë…„ì°¨")) pb.innerText = "ì „ë¬¸ì˜ ìê²© ì‹œí—˜ ë³´ê¸°";
                    else if (curLvl.type === 'intern') pb.innerText = "ì „ê³µì˜ ì§€ì›í•˜ëŸ¬ ê°€ê¸°";
                    else {
                        let jump = calculateSkipLevel() - currentLevelIdx - 1;
                        pb.innerText = (jump > 0 && currentLevelIdx < 11) ? `ğŸš€ ${jump}ë‹¨ê³„ ì›”ë°˜í•˜ê¸°` : "ì§„ê¸‰ í•˜ê¸°";
                    }
                    pb.disabled = false;
                } else { pb.classList.remove('active'); pb.innerText = "ëª©í‘œë¥¼ ë‹¬ì„±í•˜ì„¸ìš”"; pb.disabled = true; }
            }
        }
        function updateBtn(key, max) { 
            const b=document.getElementById(`btn-${key}`), c=document.getElementById(`cnt-${key}`), n=subjectCounts[key]; 
            if(c)c.innerText=`${n}/${max}`; 
            
            // ì´ë¯¸ ì™„ë£Œëœ ê³¼ëª©ì´ë©´ íšŒìƒ‰
            if(n>=max) b.classList.add('disabled');
            // ì™„ë£Œ ì•ˆëëŠ”ë° ì§€ì‹ì´ ì—†ì–´ë„ íšŒìƒ‰ (ë‹¨, ì™„ë£Œëœ ê±´ ìš°ì„ ì ìœ¼ë¡œ íšŒìƒ‰ ìœ ì§€)
            else if(currentKnowledge < KNOWLEDGE_COST) b.classList.add('disabled');
            else b.classList.remove('disabled');
        }

        // [ì¶”ê°€] íŠ¹ì • ìœ„ì¹˜ì— ì°¨ê° í…ìŠ¤íŠ¸(-100)ë¥¼ ë„ìš°ëŠ” ë„ìš°ë¯¸ í•¨ìˆ˜
        function showMinusEffect(amount, targetElement) {
            // 1. ìƒˆë¡œìš´ ê¸€ì íƒœê·¸(div)ë¥¼ ë§Œë“­ë‹ˆë‹¤.
            const effect = document.createElement('div');
            effect.innerText = amount;       // ì˜ˆ: "-100"
            effect.classList.add('minus-text'); // ì•„ê¹Œ ë§Œë“  CSS ìŠ¤íƒ€ì¼ ì ìš©
        
            // 2. í…ìŠ¤íŠ¸ê°€ ëœ° ìœ„ì¹˜ë¥¼ ê³„ì‚°í•©ë‹ˆë‹¤. (ì§€ì‹ ë°•ìŠ¤ ìœ„ì¹˜ ê¸°ì¤€)
            const rect = targetElement.getBoundingClientRect();
            // ì§€ì‹ ë°•ìŠ¤ì˜ ê°€ë¡œ ì¤‘ì•™, ì„¸ë¡œ ìƒë‹¨ì— ìœ„ì¹˜ì‹œí‚´
            effect.style.left = (rect.left + rect.width / 2 - 10) + 'px'; 
            effect.style.top = (rect.top - 20) + 'px'; // ë°•ìŠ¤ë³´ë‹¤ ì‚´ì§ ìœ„
        
            // 3. í™”ë©´ì— ë¶™ì…ë‹ˆë‹¤.
            document.body.appendChild(effect);
        
            // 4. 1ì´ˆ ë’¤ì— ì²­ì†Œ(ì‚­ì œ)í•©ë‹ˆë‹¤. (ê³„ì† ìŒ“ì´ë©´ ë ‰ ê±¸ë¦¼)
            setTimeout(() => {
                effect.remove();
            }, 1000);
        }
    </script>
</body>
</html>
